<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:AvaloniaUI.ViewModels"
        x:Class="AvaloniaUI.MainWindow"
		 x:Name="Root"
        x:DataType="vm:MainViewModel"
        mc:Ignorable="d"
        Width="1100"
        Height="650"
        MinWidth="900"
        MinHeight="500"
        Title="Nirvana Remap">
	<ScrollViewer VerticalScrollBarVisibility="Auto"
				  HorizontalScrollBarVisibility="Auto">
	<Grid RowDefinitions="Auto,*"
          ColumnDefinitions="3*,3*"
          Margin="16">

		<!-- Cabeçalho -->
		<DockPanel Grid.Row="0"
                   Grid.ColumnSpan="2"
                   LastChildFill="False"
                   Margin="0,0,0,12">

			<!-- Título + status -->
			<StackPanel DockPanel.Dock="Left"
                        Orientation="Horizontal"
                        Spacing="16"
                        VerticalAlignment="Center">
				<TextBlock Text="Nirvana Remap"
                           FontSize="24"
                           FontWeight="Bold" />

				<StackPanel>
					<TextBlock Text="{Binding Status}"
                               FontSize="14" />
					<TextBlock Text="{Binding OutputStatusText}"
                               FontSize="12"
                               Opacity="0.8" />
				</StackPanel>
			</StackPanel>

			<!-- Botões de controle -->
			<StackPanel DockPanel.Dock="Right"
                        Orientation="Horizontal"
                        Spacing="8"
                        VerticalAlignment="Center">
				<!-- Atenção: comando gerado pelo RelayCommand StartAsync -->
				<Button Content="Start"
                          Command="{Binding StartCommand}"  />
				<Button Content="Stop"
                        Command="{Binding StopCommand}" />
			</StackPanel>
		</DockPanel>

		<!-- COLUNA ESQUERDA: HUB DE MAPEAMENTO -->
		<StackPanel Grid.Row="1"
                    Grid.Column="0"
                    Spacing="8">

			<TextBlock Text="Hub de mapeamento"
                       FontSize="16"
                       FontWeight="SemiBold"
                       Margin="0,0,0,4" />

			<!-- Filtro + ações gerais -->
			
			<DockPanel Margin="0,0,0,4"
                       LastChildFill="False">
				<TextBox DockPanel.Dock="Left"
                         Width="260"
                         Watermark="Filtrar ações…"
                         Text="{Binding Hub.Filter, Mode=TwoWay}" />

				<StackPanel DockPanel.Dock="Right"
                            Orientation="Horizontal"
                            Spacing="6">
					<Button Content="Recarregar"
                            Command="{Binding Hub.ReloadCommand}" />
					<Button Content="Limpar tudo"
                            Command="{Binding Hub.ClearAllCommand}" />
				</StackPanel>
			</DockPanel>

			<!-- Lista de ações / mapeamentos -->
			<Border BorderThickness="1"
                    CornerRadius="6"
                    Padding="6">
				<ScrollViewer VerticalScrollBarVisibility="Visible"
							  HorizontalScrollBarVisibility="Auto"
						  Height="800">
					<ListBox ItemsSource="{Binding Hub.FilteredItems}">
						<ListBox.ItemTemplate>
							<DataTemplate x:DataType="vm:MappingItemVM">
								<Grid ColumnDefinitions="2*,2*,Auto,Auto"
                                      Margin="2">

									<!-- Nome da ação lógica -->
									<TextBlock Text="{Binding ActionName}"
                                               VerticalAlignment="Center" />

									<!-- Input físico atual atribuído -->
									<TextBlock Grid.Column="1"
                                               Text="{Binding AssignedDisplay}"
                                               VerticalAlignment="Center"
                                               Opacity="0.85"
                                               Margin="8,0" />

									<!-- Seleção manual + Detectar / Limpar -->
									<StackPanel Grid.Column="2"
                                                Orientation="Horizontal"
                                                Spacing="4">

										<!-- ComboBox de seleção manual de input físico -->
										<ComboBox Width="140"
										  ItemsSource="{Binding AvailableInputs}"
										  SelectedItem="{Binding Assigned, Mode=TwoWay}" />



										<Button Content="Detectar"
                                                Command="{Binding DetectCommand}" />

										<Button Content="Limpar"
                                                Command="{Binding ClearCommand}" />
									</StackPanel>

									<!-- Conflito -->
									<TextBlock Grid.Column="3"
                                               Text="{Binding ConflictNote}"
                                               Foreground="Tomato"
                                               FontSize="11"
                                               VerticalAlignment="Center"
                                               Margin="6,0,0,0" />
								</Grid>
							</DataTemplate>
						</ListBox.ItemTemplate>
					</ListBox>
				</ScrollViewer>
			</Border>

			<!-- Rodapé do Hub: conflitos + perfil + salvar -->
			<Grid ColumnDefinitions="*,Auto,Auto"
                  Margin="0,4,0,0">
				<!-- Resumo de conflitos -->
				<TextBlock Grid.Column="0"
                           Text="{Binding Hub.ConflictSummary}"
                           VerticalAlignment="Center"
                           Opacity="0.85" />

				<!-- Seleção de perfil -->
				<StackPanel Grid.Column="1"
							Orientation="Horizontal"
							Spacing="4"
							Margin="8,0">
					<TextBlock Text="Perfil:"
							   VerticalAlignment="Center"
							   FontSize="12" />
					<ComboBox Width="160"
							  ItemsSource="{Binding Hub.AvailableProfiles}"
							  SelectedItem="{Binding Hub.CurrentProfileId, Mode=TwoWay}" />
					<Button Content="+ Novo perfil"
							Command="{Binding Hub.NewProfileCommand}" />
				</StackPanel>

				<!-- Botão Salvar -->
				<Button Grid.Column="2"
                        Content="Salvar mapeamento"
                        Command="{Binding Hub.SaveCommand}"
                        IsEnabled="{Binding Hub.CanSave}" />
			</Grid>
		</StackPanel>


		<!-- COLUNA DIREITA: DIAGNÓSTICO (FÍSICO + VIRTUAL) -->
		<Grid Grid.Row="1"
			  Grid.Column="1"
			  RowDefinitions="Auto,*,*,Auto"
			  RowSpacing="8">

			<TextBlock Grid.Row="0"
					   Text="Diagnóstico de entrada e saída"
					   FontSize="16"
					   FontWeight="SemiBold"
					   Margin="0,0,0,4" />

			<!-- Controle físico -->
			<Border Grid.Row="1"
					BorderThickness="1"
					CornerRadius="6"
					Padding="6"
					Margin="0,0,0,4">
				<StackPanel Spacing="4">
					<TextBlock Text="Controle físico (entrada)"
							   FontWeight="SemiBold"
							   FontSize="14"
							   Margin="0,0,0,2" />

					<ScrollViewer VerticalScrollBarVisibility="Auto">
						<ListBox ItemsSource="{Binding CurrentInputs}">
							<ListBox.ItemTemplate>
								<DataTemplate x:DataType="vm:InputStatus">
									<DockPanel Margin="2">
										<TextBlock Text="{Binding Name}"
												   Width="150"
												   FontWeight="SemiBold"
												   DockPanel.Dock="Left" />
										<ProgressBar Minimum="0"
													 Maximum="1"
													 Width="180"
													 Height="14"
													 Margin="8,0,8,0"
													 Value="{Binding Value}" />
										<TextBlock Text="{Binding Value, StringFormat='0.000'}"
												   Width="60" />
									</DockPanel>
								</DataTemplate>
							</ListBox.ItemTemplate>
						</ListBox>
					</ScrollViewer>
				</StackPanel>
			</Border>

			<!-- Controle virtual -->
			<Border Grid.Row="2"
					BorderThickness="1"
					CornerRadius="6"
					Padding="6">
				<StackPanel Spacing="4">
					<TextBlock Text="Controle virtual (saída remapeada)"
							   FontWeight="SemiBold"
							   FontSize="14"
							   Margin="0,0,0,2" />

					<ScrollViewer VerticalScrollBarVisibility="Auto">
						<ListBox ItemsSource="{Binding VirtualOutputs}">
							<ListBox.ItemTemplate>
								<DataTemplate x:DataType="vm:InputStatus">
									<DockPanel Margin="2">
										<TextBlock Text="{Binding Name}"
												   Width="170"
												   FontWeight="SemiBold"
												   DockPanel.Dock="Left" />
										<ProgressBar Minimum="-1"
													 Maximum="1"
													 Width="180"
													 Height="14"
													 Margin="8,0,8,0"
													 Value="{Binding Value}" />
										<TextBlock Text="{Binding Value, StringFormat='0.000'}"
												   Width="60" />
									</DockPanel>
								</DataTemplate>
							</ListBox.ItemTemplate>
						</ListBox>
					</ScrollViewer>
				</StackPanel>
			</Border>


			<!-- NOVO: Modo virtual (HidHide + ViGEm) -->
			<Border Grid.Row="3"
					BorderThickness="1"
					CornerRadius="6"
					Padding="6">
				<StackPanel Spacing="6">
					<TextBlock Text="Modo virtual (HidHide + ViGEm)"
							   FontWeight="SemiBold"
							   FontSize="14"
							   Margin="0,0,0,2" />

					<TextBlock Text="Informe os IDs de dispositivos físicos a ocultar (Device Instance ID / HID path):"
							   FontSize="12"
							   Opacity="0.85" />

					<StackPanel Orientation="Horizontal"
								Spacing="4">
						<TextBox Width="420"
								 Text="{Binding NewDeviceId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
								 Watermark="Ex.: HID\VID_054C&amp;PID_09CC\..." />
						<Button Content="Adicionar"
								Command="{Binding AddDeviceIdCommand}" />
					</StackPanel>

					<ItemsControl ItemsSource="{Binding DevicesToHide}">
						<ItemsControl.ItemTemplate>
							<DataTemplate>
								<DockPanel Margin="2">
									<TextBlock Text="{Binding .}"
											   DockPanel.Dock="Left"
											   Width="420"
											   TextTrimming="CharacterEllipsis" />
									<Button Content="Remover"
											DockPanel.Dock="Right"
										  Command="{Binding #Root.DataContext.RemoveDeviceIdCommand}"
											CommandParameter="{Binding .}" />
								</DockPanel>
							</DataTemplate>
						</ItemsControl.ItemTemplate>
					</ItemsControl>

					<StackPanel Orientation="Horizontal"
								Spacing="8"
								Margin="0,4,0,0">
						<Button Content="Ativar modo virtual"
								Command="{Binding EnableVirtualModeCommand}" />

						<Button Content="Desativar ocultação"
								Command="{Binding DisableVirtualModeCommand}" />
					</StackPanel>
				</StackPanel>
			</Border>

			</Grid>

		</Grid>
	</ScrollViewer>
</Window>
